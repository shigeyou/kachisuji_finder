generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model CoreService {
  id          String   @id @default(cuid())
  name        String
  category    String?
  description String?
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CoreAsset {
  id          String   @id @default(cuid())
  name        String
  type        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Constraint {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Exploration {
  id          String   @id @default(cuid())
  question    String
  context     String?
  constraints String
  status      String   @default("completed")
  result      String?
  error       String?
  userId      String?  // ユーザー別データ用（null = 共有/レガシー）
  userName    String?  // 表示用ユーザー名
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model RAGDocument {
  id        String   @id @default(cuid())
  filename  String
  fileType  String
  content   String
  metadata  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ScoreBaseline {
  id              String   @id @default(cuid())
  date            DateTime @default(now())
  runId           String?
  topScore        Float
  avgScore        Float
  totalStrategies Int
  highScoreCount  Int
  improvement     Float?
  createdAt       DateTime @default(now())
}

model TopStrategy {
  id                String   @id @default(cuid())
  explorationId     String
  name              String
  reason            String
  howToObtain       String?
  totalScore        Float
  scores            String
  question          String
  judgment          String
  learningExtracted Boolean  @default(false)
  userId            String?  // ユーザー別ランキング用（null = レガシー）
  userName          String?  // 表示用
  createdAt         DateTime @default(now())

  @@index([totalScore])
  @@index([learningExtracted])
  @@index([userId])
}

model AutoExploreRun {
  id                    String    @id @default(cuid())
  status                String    @default("running")
  triggerType           String    @default("manual")
  questionsGenerated    Int       @default(0)
  explorationsCompleted Int       @default(0)
  highScoresFound       Int       @default(0)
  topScore              Float?
  topStrategyName       String?
  baselineScore         Float?
  achievedScore         Float?
  improvement           Float?
  startedAt             DateTime  @default(now())
  completedAt           DateTime?
  duration              Int?
  errors                String?
  userId                String?   // ユーザー別自動探索用
  userName              String?   // 表示用

  @@index([userId])
}

model LearningMemory {
  id              String    @id @default(cuid())
  type            String
  category        String?
  pattern         String
  examples        String
  evidence        String?
  confidence      Float     @default(0.5)
  validationCount Int       @default(0)
  successRate     Float?
  usedCount       Int       @default(0)
  lastUsedAt      DateTime?
  isActive        Boolean   @default(true)
  userId          String?   // ユーザー別学習用（null = 共有/レガシー）
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([confidence])
  @@index([userId])
}

model StrategyDecision {
  id              String   @id @default(cuid())
  explorationId   String
  strategyName    String
  decision        String
  reason          String?
  feasibilityNote String?
  userId          String?  // ユーザー別判断用（null = 共有/レガシー）
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([explorationId, strategyName, userId])
  @@index([decision])
  @@index([createdAt])
  @@index([userId])
}

model DefaultSwot {
  id            String   @id @default("default")
  strengths     String
  weaknesses    String
  opportunities String
  threats       String
  summary       String?
  updatedAt     DateTime @updatedAt
  updatedBy     String?
}

model MetaAnalysisRun {
  id                String   @id @default(cuid())
  totalExplorations Int
  totalStrategies   Int
  topStrategies     String   // JSON array
  frequentTags      String   // JSON array
  clusters          String   // JSON array
  blindSpots        String   // JSON array
  thinkingProcess   String
  userId            String?  // ユーザー別メタ分析用（null = レガシー）
  userName          String?  // 表示用
  createdAt         DateTime @default(now())

  @@index([userId])
}

// 対象企業プロファイル（勝ち筋探索の主体）
model CompanyProfile {
  id                String   @id @default("default")
  name              String   // 会社名
  shortName         String?  // 略称
  description       String?  // 会社概要
  background        String?  // 背景・経緯（例：合併など）
  techStack         String?  // 技術基盤の説明
  parentCompany     String?  // 親会社名
  parentRelation    String?  // 親会社との関係
  industry          String?  // 業界
  additionalContext String?  // その他の文脈情報
  updatedAt         DateTime @updatedAt
}

// ユーザー別スコア設定
model UserScoreConfig {
  id                   String   @id @default(cuid())
  userId               String   @unique // ユーザーごとに1件
  revenuePotential     Int      @default(30)
  timeToRevenue        Int      @default(20)
  competitiveAdvantage Int      @default(20)
  executionFeasibility Int      @default(15)
  hqContribution       Int      @default(10)
  mergerSynergy        Int      @default(5)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ユーザー別探索まとめ
model ExploreSummary {
  id        String   @id @default(cuid())
  userId    String
  content   String   // JSON形式のまとめ内容
  stats     String?  // JSON形式の統計情報
  createdAt DateTime @default(now())

  @@index([userId])
}

// ネット情報（RAG参照用の外部URL）
model WebSource {
  id          String   @id @default(cuid())
  name        String   // 表示名（例：商船三井マリテックス）
  url         String   // URL
  description String?  // 説明（オプション）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
